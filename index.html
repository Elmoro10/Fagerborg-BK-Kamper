<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Terminliste – Fagerborg BK (2026)</title>

  <style>
    :root{
      /* Match tabell-repoet */
      --bg:#f3f4f6;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#6b7280;
      --line:#e5e7eb;
      --head:#f8fafc;

      --radius:14px;
      --shadow: 0 10px 30px rgba(15, 23, 42, .08);

      /* Fagerborg highlight (samme “our” stil) */
      --our-bg: rgba(22,163,74,.12);
      --our-text: #16a34a;

      /* Chips */
      --chip:#f3f4f6;
      --chipText:#374151;
      --chipOkBg: rgba(22,163,74,.12);
      --chipOkText: #16a34a;
      --chipBadBg: rgba(220,38,38,.12);
      --chipBadText: #dc2626;

      /* Match-list layout */
      --datew: 150px;
      --scorew: 70px;

      /* Tabs */
      --tabBg: #f3f4f6;
      --tabBorder: #e5e7eb;
      --tabActive: #ffffff;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:var(--bg);
      color:var(--text);
    }

    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:12px 10px;
    }

    .grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    @media(max-width: 920px){
      .grid{ grid-template-columns:1fr; }
    }
    .grid.single{ grid-template-columns: 1fr; }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      min-width:0;
    }

    .card-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      background:var(--head);
    }

    .card-title{
      font-weight:900;
      font-size:18px;
      letter-spacing:-.01em;
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }

    .team-mark{
      width:10px;
      height:22px;
      border-radius:999px;
      background: var(--our-text);
      box-shadow: inset 0 0 0 1px rgba(15,23,42,.06);
      flex:0 0 auto;
    }

    .badge{
      font-size:12px;
      color:var(--muted);
      border:1px solid var(--line);
      background:#fff;
      padding:6px 10px;
      border-radius:999px;
      white-space:nowrap;
    }

    /* Tabs */
    .tabs{
      padding:10px 12px 0;
    }
    .tab-wrap{
      display:flex;
      gap:6px;
      background:var(--tabBg);
      border:1px solid var(--tabBorder);
      padding:5px;
      border-radius:999px;
    }
    .tab{
      flex:1 1 auto;
      border:1px solid transparent;
      background: transparent;
      color: var(--muted);
      font-weight:900;
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      cursor:pointer;
      white-space:nowrap;
    }
    .tab[aria-selected="true"]{
      background: var(--tabActive);
      border-color: var(--line);
      color: var(--text);
    }

    /* Match list */
    .list{
      padding:10px 12px 12px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .match{
      position:relative;
      display:grid;
      grid-template-columns: var(--datew) 1fr var(--scorew);
      gap:10px;
      align-items:center;
      padding:10px 10px;
      border:1px solid var(--line);
      border-radius:12px;
      background:#fff;
      min-width:0;
    }

    @media (max-width: 520px){
      :root{ --datew: 1fr; --scorew: 1fr; }
      .match{
        grid-template-columns: 1fr;
        gap:8px;
      }
    }

    .match.our{
      background: var(--our-bg);
      border-color: rgba(22,163,74,.18);
    }
    .match.our::before{
      content:"";
      position:absolute;
      left:0; top:0; bottom:0;
      width:4px;
      background: var(--our-text);
    }

    .when{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }
    .dt{
      font-weight:900;
      font-size:13px;
      letter-spacing:-.01em;
      color: var(--text);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .venue{
      font-size:12px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .versus{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .team{
      display:flex;
      align-items:center;
      gap:8px;
      min-width:0;
      flex: 1 1 0;
    }
    .team.right{ justify-content:flex-end; }
    .name{
      font-weight:900;
      font-size:13px;
      letter-spacing:-.01em;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      color: var(--text);
    }
    .vs{
      font-weight:900;
      font-size:12px;
      color: var(--muted);
      letter-spacing:.04em;
      flex:0 0 auto;
    }

    .logo{
      width:22px;
      height:22px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      object-fit:contain;
      flex:0 0 auto;
    }
    .logo.fallback{
      background:#e5e7eb;
      border:1px solid #d1d5db;
    }

    .rightbox{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:6px;
    }
    @media (max-width: 520px){
      .rightbox{ align-items:flex-start; }
    }

    .score{
      font-weight:900;
      font-size:14px;
      letter-spacing:-.01em;
      color: var(--text);
      white-space:nowrap;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      padding:5px 9px;
      border-radius:999px;
      font-size:11px;
      font-weight:900;
      background: var(--chip);
      color: var(--chipText);
      border:1px solid var(--line);
      white-space:nowrap;
    }
    .chip.ok{
      background: var(--chipOkBg);
      color: var(--chipOkText);
      border-color: rgba(22,163,74,.18);
    }
    .chip.bad{
      background: var(--chipBadBg);
      color: var(--chipBadText);
      border-color: rgba(220,38,38,.18);
    }

    .loading,.error{
      padding:12px;
      margin:10px;
      border-radius:12px;
      font-size:14px;
      background:#fff;
    }
    .loading{
      color:var(--muted);
      border:1px dashed #d1d5db;
    }
    .error{
      background:#fee2e2;
      border:1px solid #fecaca;
      color:#991b1b;
      white-space:pre-wrap;
    }
    .empty{
      padding:12px;
      border-radius:12px;
      border:1px dashed #d1d5db;
      background:#fff;
      color:var(--muted);
      font-size:14px;
    }

    /* FRONT / COMPACT MODE (view=front) */
    body.front .wrap{ max-width: 680px; }

    .front-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      padding:10px 12px 12px;
    }
    @media(max-width: 760px){
      .front-grid{ grid-template-columns: 1fr; }
    }

    .mini{
      border:1px solid var(--line);
      border-radius:12px;
      background:#fff;
      padding:10px;
      min-width:0;
    }
    .mini-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }
    .mini-title{
      font-weight:900;
      letter-spacing:-.01em;
    }
    .mini-badge{
      font-size:12px;
      color:var(--muted);
      border:1px solid var(--line);
      background:#fff;
      padding:6px 10px;
      border-radius:999px;
      white-space:nowrap;
    }
    .mini-body{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .mini-lines{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
      flex:1 1 auto;
    }
    .mini-line1{
      display:flex;
      align-items:center;
      gap:8px;
      min-width:0;
    }
    .mini-opp{
      font-weight:900;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .mini-score{
      font-weight:900;
      white-space:nowrap;
    }
    .mini-line2{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <section class="grid" id="grid"></section>
  </div>

  <script>
    function esc(s){
      return String(s ?? "").replace(/[&<>"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[m]));
    }

    function repoBaseUrl(){
      const p = location.pathname;
      const root = p.endsWith("/") ? p : p.substring(0, p.lastIndexOf("/") + 1);
      return location.origin + root;
    }

    function toAbsMaybe(u){
      const s = String(u || "").trim();
      if (!s) return "";
      if (s.startsWith("http://") || s.startsWith("https://")) return s;
      return repoBaseUrl() + s.replace(/^\//, "");
    }

    function fmtNo(dtIso){
      try{
        const d = new Date(dtIso);
        return d.toLocaleString('nb-NO', {
          weekday:'short',
          year:'numeric',
          month:'2-digit',
          day:'2-digit',
          hour:'2-digit',
          minute:'2-digit'
        }).replace(',', '');
      }catch{
        return "Ukjent tid";
      }
    }

    function parseKickoffMs(m){
      const t = Date.parse(m.kickoff);
      return Number.isFinite(t) ? t : NaN;
    }

    function isFinished(m){
      return String(m.status || "").toUpperCase() === "FINISHED" ||
        (Number.isFinite(m.homeGoals) && Number.isFinite(m.awayGoals));
    }

    function scoreText(m){
      if (Number.isFinite(m.homeGoals) && Number.isFinite(m.awayGoals)) return `${m.homeGoals}\u2013${m.awayGoals}`;
      return "–";
    }

    function statusChip(m){
      const s = String(m.status || "").toUpperCase();
      if (s === "CANCELLED") return { text:"Avlyst", cls:"chip bad" };
      if (isFinished(m)) return { text:"Spilt", cls:"chip ok" };
      return { text:"Kommende", cls:"chip" };
    }

    function isFagerborgMatch(teamObj, m){
      const tn = String(teamObj?.teamName || "Fagerborg").toLowerCase();
      const home = String(m.homeTeam || "").toLowerCase();
      const away = String(m.awayTeam || "").toLowerCase();
      return home.includes(tn) || away.includes(tn);
    }

    function safeUrl(u){
      try{
        if (!u) return "";
        return new URL(u, location.href).href;
      }catch{
        return "";
      }
    }

    function logoNode(url){
      const abs = toAbsMaybe(url);
      if (!abs){
        const sp = document.createElement("span");
        sp.className = "logo fallback";
        return sp;
      }
      const img = document.createElement("img");
      img.className = "logo";
      img.loading = "lazy";
      img.alt = "";
      img.src = abs;
      img.onerror = () => {
        const sp = document.createElement("span");
        sp.className = "logo fallback";
        img.replaceWith(sp);
      };
      return img;
    }

    function matchRow(teamObj, m){
      const row = document.createElement("div");
      row.className = "match" + (isFagerborgMatch(teamObj, m) ? " our" : "");

      const when = document.createElement("div");
      when.className = "when";

      const dt = document.createElement("div");
      dt.className = "dt";
      dt.textContent = fmtNo(m.kickoff);

      const venue = document.createElement("div");
      venue.className = "venue";
      venue.textContent = String(m.venue || "");
      venue.title = String(m.venue || "");

      when.append(dt, venue);

      const versus = document.createElement("div");
      versus.className = "versus";

      const home = document.createElement("div");
      home.className = "team";
      home.append(
        logoNode(m.homeLogoUrl),
        Object.assign(document.createElement("div"), { className:"name", title:String(m.homeTeam||"") , textContent:String(m.homeTeam||"Ukjent") })
      );

      const vs = document.createElement("div");
      vs.className = "vs";
      vs.textContent = "VS";

      const away = document.createElement("div");
      away.className = "team right";
      away.append(
        Object.assign(document.createElement("div"), { className:"name", title:String(m.awayTeam||"") , textContent:String(m.awayTeam||"Ukjent") }),
        logoNode(m.awayLogoUrl)
      );

      versus.append(home, vs, away);

      const right = document.createElement("div");
      right.className = "rightbox";

      const sc = document.createElement("div");
      sc.className = "score";
      sc.textContent = scoreText(m);

      const chip = statusChip(m);
      const ch = document.createElement("div");
      ch.className = chip.cls;
      ch.textContent = chip.text;

      right.append(sc, ch);

      row.append(when, versus, right);

      const u = safeUrl(m.matchUrl);
      if (u){
        row.style.cursor = "pointer";
        row.title = "Åpne kamp på fotball.no";
        row.addEventListener("click", () => {
          if (window.getSelection && String(window.getSelection()).length > 0) return;
          window.open(u, "_blank", "noopener");
        });
      }

      return row;
    }

    // ✅ KRAV:
    // - Kommende / Siste spilte = bare Fagerborg
    // - Alle lag = hele turnering/avdeling
    function filterMatches(teamObj, mode){
      const ms = Array.isArray(teamObj?.matches) ? teamObj.matches.slice() : [];
      const now = Date.now();

      const getT = (m) => {
        const t = parseKickoffMs(m);
        return Number.isFinite(t) ? t : (mode === "played" ? -Infinity : Infinity);
      };

      const isFbk = (m) => isFagerborgMatch(teamObj, m);

      if (mode === "upcoming"){
        const x = ms.filter(m => {
          const t = parseKickoffMs(m);
          if (!Number.isFinite(t)) return false;
          if (!isFbk(m)) return false;
          return t >= now && String(m.status || "").toUpperCase() !== "CANCELLED";
        });
        x.sort((a,b) => getT(a) - getT(b));
        return x;
      }

      if (mode === "played"){
        const x = ms.filter(m => {
          const t = parseKickoffMs(m);
          if (!Number.isFinite(t)) return false;
          if (!isFbk(m)) return false;
          return t < now;
        });
        x.sort((a,b) => getT(b) - getT(a));
        return x;
      }

      // "all" -> alle lag
      ms.sort((a,b) => getT(a) - getT(b));
      return ms;
    }

    function makeCard(teamKey, teamObj){
      const title = teamKey === "a" ? "A-Laget" : "B-Laget";
      const badgeText = String(teamObj?.tournament || "2026");

      const card = document.createElement("div");
      card.className = "card";

      const head = document.createElement("div");
      head.className = "card-head";

      const left = document.createElement("div");
      left.className = "card-title";
      left.append(Object.assign(document.createElement("span"), { className:"team-mark" }));
      left.append(Object.assign(document.createElement("span"), { textContent: title }));

      const badge = document.createElement("div");
      badge.className = "badge";
      badge.textContent = badgeText;

      head.append(left, badge);
      card.appendChild(head);

      // Tabs
      const tabs = document.createElement("div");
      tabs.className = "tabs";
      const wrap = document.createElement("div");
      wrap.className = "tab-wrap";
      wrap.setAttribute("role", "tablist");

      const btnUpcoming = document.createElement("button");
      btnUpcoming.className = "tab";
      btnUpcoming.setAttribute("role","tab");
      btnUpcoming.setAttribute("aria-selected","true");
      btnUpcoming.type = "button";
      btnUpcoming.textContent = "Kommende";

      const btnPlayed = document.createElement("button");
      btnPlayed.className = "tab";
      btnPlayed.setAttribute("role","tab");
      btnPlayed.setAttribute("aria-selected","false");
      btnPlayed.type = "button";
      btnPlayed.textContent = "Siste spilte";

      const btnAll = document.createElement("button");
      btnAll.className = "tab";
      btnAll.setAttribute("role","tab");
      btnAll.setAttribute("aria-selected","false");
      btnAll.type = "button";
      btnAll.textContent = "Alle lag";

      wrap.append(btnUpcoming, btnPlayed, btnAll);
      tabs.appendChild(wrap);
      card.appendChild(tabs);

      const list = document.createElement("div");
      list.className = "list";
      card.appendChild(list);

      const state = { mode: "upcoming" };

      function setSelected(mode){
        state.mode = mode;
        btnUpcoming.setAttribute("aria-selected", mode === "upcoming" ? "true" : "false");
        btnPlayed.setAttribute("aria-selected", mode === "played" ? "true" : "false");
        btnAll.setAttribute("aria-selected", mode === "all" ? "true" : "false");
        renderList();
      }

      function renderList(){
        list.innerHTML = "";
        const ms = filterMatches(teamObj, state.mode);
        if (!ms.length){
          const d = document.createElement("div");
          d.className = "empty";
          d.textContent =
            state.mode === "upcoming" ? "Ingen kommende Fagerborg-kamper funnet."
            : state.mode === "played" ? "Ingen spilte Fagerborg-kamper funnet."
            : "Ingen kamper funnet.";
          list.appendChild(d);
          return;
        }
        ms.forEach(m => list.appendChild(matchRow(teamObj, m)));
      }

      btnUpcoming.addEventListener("click", () => setSelected("upcoming"));
      btnPlayed.addEventListener("click", () => setSelected("played"));
      btnAll.addEventListener("click", () => setSelected("all"));

      renderList();
      return card;
    }

    function makeFrontCard(teamKey, teamObj){
      const title = teamKey === "a" ? "A-Laget" : "B-Laget";
      const badgeText = String(teamObj?.tournament || "2026");

      const card = document.createElement("div");
      card.className = "card";

      const head = document.createElement("div");
      head.className = "card-head";

      const left = document.createElement("div");
      left.className = "card-title";
      left.append(Object.assign(document.createElement("span"), { className:"team-mark" }));
      left.append(Object.assign(document.createElement("span"), { textContent: `${title}` }));

      const badge = document.createElement("div");
      badge.className = "badge";
      badge.textContent = badgeText;

      head.append(left, badge);
      card.appendChild(head);

      const msAll = Array.isArray(teamObj?.matches) ? teamObj.matches.slice() : [];
      const now = Date.now();
      const fbk = msAll
        .map(m => ({ m, t: parseKickoffMs(m) }))
        .filter(x => Number.isFinite(x.t))
        .filter(x => isFagerborgMatch(teamObj, x.m));

      const next = fbk
        .filter(x => x.t >= now && String(x.m.status || "").toUpperCase() !== "CANCELLED")
        .sort((a,b) => a.t - b.t)[0]?.m || null;

      const last = fbk
        .filter(x => x.t < now)
        .sort((a,b) => b.t - a.t)[0]?.m || null;

      function mini(titleText, m, badgeText){
        const box = document.createElement("div");
        box.className = "mini";

        const top = document.createElement("div");
        top.className = "mini-top";
        top.append(Object.assign(document.createElement("div"), { className:"mini-title", textContent:titleText }));
        top.append(Object.assign(document.createElement("div"), { className:"mini-badge", textContent:badgeText }));
        box.appendChild(top);

        if (!m){
          const e = document.createElement("div");
          e.className = "empty";
          e.textContent = "Ingen kamp funnet.";
          box.appendChild(e);
          return box;
        }

        const u = safeUrl(m.matchUrl);

        const body = document.createElement("div");
        body.className = "mini-body";

        body.append(logoNode(m.homeLogoUrl), logoNode(m.awayLogoUrl));

        const lines = document.createElement("div");
        lines.className = "mini-lines";

        const line1 = document.createElement("div");
        line1.className = "mini-line1";

        const opp = document.createElement("div");
        opp.className = "mini-opp";
        opp.textContent = `${m.homeTeam || "Ukjent"} – ${m.awayTeam || "Ukjent"}`;

        const sc = document.createElement("div");
        sc.className = "mini-score";
        sc.textContent = scoreText(m);

        line1.append(opp, sc);

        const line2 = document.createElement("div");
        line2.className = "mini-line2";
        const dt = fmtNo(m.kickoff);
        line2.textContent = dt + (m.venue ? ` · ${m.venue}` : "");
        line2.title = line2.textContent;

        lines.append(line1, line2);
        body.appendChild(lines);
        box.appendChild(body);

        if (u){
          box.style.cursor = "pointer";
          box.title = "Åpne kamp på fotball.no";
          box.addEventListener("click", () => window.open(u, "_blank", "noopener"));
        }

        return box;
      }

      const fg = document.createElement("div");
      fg.className = "front-grid";
      fg.append(
        mini("Neste kamp", next, "Kommende"),
        mini("Sist spilte", last, "Siste")
      );
      card.appendChild(fg);

      return card;
    }

    function applyTeamMode(){
      const params = new URLSearchParams(location.search);
      const team = (params.get("team") || "both").toLowerCase(); // a|b|both
      const view = (params.get("view") || "").toLowerCase();

      if (view === "front"){
        document.body.classList.add("front");
      } else {
        document.body.classList.remove("front");
      }

      const grid = document.getElementById("grid");
      grid.className = "grid";
      if (team === "a" || team === "b") grid.classList.add("single");

      return { team, view };
    }

    function renderLoading(grid, mode){
      grid.innerHTML = "";

      const mk = (title) => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="card-head">
            <div class="card-title"><span class="team-mark"></span><span>${esc(title)}</span></div>
            <div class="badge">2026</div>
          </div>
          <div class="loading">Laster…</div>
        `;
        return card;
      };

      if (mode.team === "a"){
        grid.appendChild(mk("A-Laget"));
      } else if (mode.team === "b"){
        grid.appendChild(mk("B-Laget"));
      } else {
        grid.appendChild(mk("A-Laget"));
        grid.appendChild(mk("B-Laget"));
      }
    }

    function renderError(grid, mode, msg){
      grid.innerHTML = "";
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <div class="card-head">
          <div class="card-title"><span class="team-mark"></span><span>Kunne ikke hente data</span></div>
          <div class="badge">2026</div>
        </div>
        <div class="error">${esc(msg || "Ukjent feil.")}</div>
      `;
      grid.appendChild(card);
    }

    function renderData(grid, mode, data){
      grid.innerHTML = "";

      const aObj = data?.a || null;
      const bObj = data?.b || null;

      if (mode.view === "front"){
        if (mode.team === "a"){
          grid.appendChild(makeFrontCard("a", aObj));
        } else if (mode.team === "b"){
          grid.appendChild(makeFrontCard("b", bObj));
        } else {
          grid.appendChild(makeFrontCard("a", aObj));
          grid.appendChild(makeFrontCard("b", bObj));
        }
        return;
      }

      if (mode.team === "a"){
        grid.appendChild(makeCard("a", aObj));
      } else if (mode.team === "b"){
        grid.appendChild(makeCard("b", bObj));
      } else {
        grid.appendChild(makeCard("a", aObj));
        grid.appendChild(makeCard("b", bObj));
      }
    }

    async function loadAndRender(){
      const grid = document.getElementById("grid");
      const mode = applyTeamMode();
      renderLoading(grid, mode);

      const url = repoBaseUrl() + "data/matches.json?ts=" + Date.now();

      try{
        const res = await fetch(url, { cache:"no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const json = await res.json();

        if (!json || typeof json !== "object"){
          renderError(grid, mode, "Dataformatet var uventet.");
          return;
        }

        renderData(grid, mode, json);
      }catch(e){
        renderError(grid, mode, "Feil ved lasting av matches.json:\n" + (e.message || String(e)));
      }
    }

    window.addEventListener("DOMContentLoaded", () => {
      applyTeamMode();
      loadAndRender();
      setInterval(loadAndRender, 60 * 1000);
    });
  </script>
</body>
</html>
